// Optimized Prisma Schema with Natural Keys
// Allows teams and stats to be upserted in parallel (no dependency!)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// NBA Teams
model NBATeam {
  id           Int            @id @default(autoincrement())
  teamId       Int            @unique @map("team_id") // Natural key - used by stats
  abbreviation String         @unique
  name         String
  city         String
  conference   String
  division     String
  createdAt    DateTime       @default(now()) @map("created_at")
  updatedAt    DateTime       @updatedAt @map("updated_at")
  
  // Relations
  homeGames    NBAGame[]      @relation("HomeTeam")
  awayGames    NBAGame[]      @relation("AwayTeam")
  teamStats    NBATeamStats[]

  // ðŸš€ PERFORMANCE: Indexes for fast lookups
  @@index([teamId])
  @@index([abbreviation])
  @@map("nba_teams")
}

// NBA Games
model NBAGame {
  id         Int      @id @default(autoincrement())
  gameId     String   @unique @map("game_id")
  gameDate   DateTime @map("game_date")
  season     String
  homeTeamId Int      @map("home_team_id")
  awayTeamId Int      @map("away_team_id")
  homeScore  Int?     @map("home_score")
  awayScore  Int?     @map("away_score")
  status     String
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")
  
  // Relations
  homeTeam   NBATeam  @relation("HomeTeam", fields: [homeTeamId], references: [id], onDelete: Cascade)
  awayTeam   NBATeam  @relation("AwayTeam", fields: [awayTeamId], references: [id], onDelete: Cascade)

  // ðŸš€ PERFORMANCE: Indexes for common query patterns
  @@index([gameId])
  @@index([season])
  @@index([gameDate])
  @@index([season, gameDate])
  @@index([homeTeamId])
  @@index([awayTeamId])
  @@map("nba_games")
}

// Team Statistics (aggregated by season)
// ðŸ”‘ KEY CHANGE: Uses nbaTeamId (references NBATeam.teamId) instead of surrogate key
model NBATeamStats {
  id                Int      @id @default(autoincrement())
  nbaTeamId         Int      @map("nba_team_id") // ðŸš€ Natural key - no dependency on auto-increment!
  season            String
  gamesPlayed       Int      @map("games_played")
  wins              Int
  losses            Int
  
  // Offensive Stats
  pointsPerGame     Float    @map("points_per_game")
  fieldGoalPct      Float    @map("field_goal_pct")
  threePointPct     Float    @map("three_point_pct")
  freeThrowPct      Float    @map("free_throw_pct")
  assistsPerGame    Float    @map("assists_per_game")
  reboundsPerGame   Float    @map("rebounds_per_game")
  turnoversPerGame  Float    @map("turnovers_per_game")
  
  // Defensive Stats
  oppPointsPerGame  Float    @map("opp_points_per_game")
  oppFieldGoalPct   Float    @map("opp_field_goal_pct")
  oppThreePointPct  Float    @map("opp_three_point_pct")
  
  // Advanced Metrics
  offensiveRating   Float?   @map("offensive_rating")
  defensiveRating   Float?   @map("defensive_rating")
  pace              Float?

  // NEW: Pythagorean Expectation Metrics
  totalPointsScored    Float?   @map("total_points_scored")    // Sum of all points scored
  totalPointsAllowed   Float?   @map("total_points_allowed")   // Sum of all points allowed
  pythagoreanWinPct    Float?   @map("pythagorean_win_pct")    // Calculated expectation
  luckFactor           Float?   @map("luck_factor")            // Actual - Expected

  // NEW: Home/Away Splits
  homeWins             Int      @default(0) @map("home_wins")
  homeLosses           Int      @default(0) @map("home_losses")
  awayWins             Int      @default(0) @map("away_wins")
  awayLosses           Int      @default(0) @map("away_losses")

  // NEW: Four Factors - Offensive
  effectiveFGPct       Float?   @map("effective_fg_pct")
  turnoverPct          Float?   @map("turnover_pct")
  offensiveReboundPct  Float?   @map("offensive_rebound_pct")
  freeThrowRate        Float?   @map("free_throw_rate")
  
  // NEW: Four Factors - Defensive
  oppEffectiveFGPct    Float?   @map("opp_effective_fg_pct")
  oppTurnoverPct       Float?   @map("opp_turnover_pct")
  oppOffensiveReboundPct Float? @map("opp_offensive_rebound_pct")
  oppFreeThrowRate     Float?   @map("opp_free_throw_rate")
  
  // Meta
  lastUpdated       DateTime @default(now()) @map("last_updated")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  
  // Relation - references natural key!
  team              NBATeam  @relation(fields: [nbaTeamId], references: [teamId], onDelete: Cascade)

  // ðŸš€ PERFORMANCE: Indexes and constraints
  @@unique([nbaTeamId, season], name: "nbaTeamId_season")
  @@index([nbaTeamId])
  @@index([season])
  @@map("nba_team_stats")
}
